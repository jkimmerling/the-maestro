schema: 1
story: "0.4"
story_title: "Anthropic Provider Migration & Integration"
gate: PENDING
status_reason: "OAuth E2E pending manual authorization. API‑key run attempted with real key, but Anthropic returned 400: insufficient credit."
reviewer: "Quinn (Test Architect)"
updated: "$(date -u +%FT%TZ)"

waiver: { active: false }

top_issues: []

quality_score: 0
expires: "$(date -u -v+14d +%FT%TZ 2>/dev/null || date -u -d '+14 days' +%FT%TZ)"

evidence:
  tests_reviewed: 145
  risks_identified: 0
  pre_push_executed: true
  real_api_validated: false
  real_api_required: true
  precommit:
    executed: true
    timestamp: "$(date -u +%FT%TZ)"
    summary: "3 doctests, 145 tests, 0 failures"
    output_snippet: |-
      Skipping real API test - no ANTHROPIC_API_KEY environment variable
      Finished in ~1.6s
      3 doctests, 145 tests, 0 failures
  latest_run:
    when: "$(date -u +%FT%TZ)"
    session: "enterprise_test_anthropic"
    model: "claude-3-haiku-20240307"
    anthropic_api_key_len: 108
    results:
      api_key_http_error: 400
      api_key_http_error_reason: "insufficient_credit"
      oauth_http_error: 400
      oauth_http_error_reason: "credential_restricted_for_claude_code"
      model_list_ok: true
    notes: |
      API‑key E2E attempted with REAL key from env but returned insufficient credit.
      OAuth E2E: tokens saved for session 'oauth_test_anthropic'; models list works, but POST /v1/messages returns 400 with message:
        "This credential is only authorized for use with Claude Code and cannot be used for other API requests."
      Action needed: Provide funded API key or authorize via an Anthropic OAuth app that grants inference API access (not Claude Code only).
  trace:
    ac_covered: [1, 2, 3, 4, 5]
    ac_gaps: [4]

nfr_validation:
  security:
    status: PENDING
    notes: |
      Real API key not yet validated on this machine. Keys are never printed; use env injection only.
  performance:
    status: PENDING
    notes: "Streaming performance validation to follow after real-run evidence."
  reliability:
    status: PASS
    notes: "Named sessions persisted; retries and error handling in place."
  maintainability:
    status: PASS
    notes: "Follows provider interface; clear module boundaries and typespecs."

qa_directives:
  - "E2E validations MUST use a REAL Anthropic API key from env (`ANTHROPIC_API_KEY`)."
  - "Do NOT use dummy keys for success-path validation."
  - "Use provided scripts for manual OAuth URL generation and code exchange."

recommendations:
  immediate:
    - action: "Run API‑key E2E and OAuth E2E and attach evidence to this gate"
      refs: ["scripts/test_anthropic_api_key_streaming_e2e.exs", "scripts/test_full_anthropic_oauth_streaming_e2e.exs"]
  future:
    - action: "Add unit tests for header presence/assertions in streaming requests"
      refs: ["lib/the_maestro/providers/anthropic/streaming.ex", "lib/the_maestro/providers/http/streaming_adapter.ex"]

hook_metrics:
  compilation_time: "n/a"
  test_execution_time: "~1.6s"
  test_count: 145
  test_failures: 0
  credo_issues_total: 0
  credo_issues_critical: 0
  dialyzer_warnings: 0
  formatting_issues: 0
