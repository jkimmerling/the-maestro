# Story 1.7: Agent Tools — Core Implementation (Gemini CLI Parity)

## Status
In Progress — schema + basic context scaffolding completed (2025-09-03)

## Summary
Implement a provider‑agnostic tools subsystem matching Gemini CLI behavior with a working directory per agent, persistent audit logging, provider translators (Gemini/OpenAI Responses/Anthropic), and a robust web search stack (Tavily, DuckDuckGo, Hound, Crawly). Wire the streaming loop to execute tools and continue responses, enforce strong safety defaults (never sudo; global denylist), and use token‑aware truncation (~100k tokens default, configurable). ALL testing and debugging MUST use REAL providers and REAL credentials.

- Canonical reference for tool behavior: /Users/jasonk/Development/the_maestro/source/gemini-cli
- Gemini tool docs (required to mirror):
  - source/gemini-cli/docs/tools/index.md
  - source/gemini-cli/docs/tools/file-system.md
  - source/gemini-cli/docs/tools/shell.md
  - source/gemini-cli/docs/tools/web-fetch.md
  - source/gemini-cli/docs/tools/web-search.md
  - source/gemini-cli/docs/tools/multi-file.md
  - source/gemini-cli/docs/tools/mcp-server.md (interface only; protocol in future story)
- Provider tool specs (required for translators):
  - docs/tool-specs/tool_call_matrix-codex.md
  - docs/tool-specs/anthropic_tool_specs.md
  - docs/tool-specs/codex_tool_specs-codex.md
  - docs/tool-specs/gemini_tool_specs-codex.md

STRICT RULES
- Zero tolerance: DO NOT bypass git hooks. Never use --no-verify or force-push. If hooks fail, fix the issues.
- Manual testing: Run servers/tools without timeouts; do not use 10s timeouts while testing. Kill the process when finished.
- ALL testing and debugging MUST use REAL providers and REAL credentials.
- Use Req for HTTP. Do not add Tesla/HTTPoison/Tesla-like libs.
- Follow Phoenix v1.8 + HEEx + LiveView rules stated in project guidelines.

## Owner‑Approved Decisions
- Shell defaults: Allow all by default; NEVER allow sudo; enforce a global denylist; denylist always overrides allowlist; UI exposes granular prefix controls and “Select All/Per‑tool” toggles.
- ToolRun persistence: Persist agent_id, session_id, timestamps, status/exit_code, stdout/stderr summaries, bytes read/written, provider metadata, and full call_request/call_response payloads.
- Web search backends: Add Tavily (TAVILY_API_KEY), DuckDuckGo (Req), plus fully integrate Hound (browser automation) and Crawly (crawler with Render Server). Backends are prioritized per agent.
- Tokenization/truncation: Multi‑method estimator (several methods; drop outliers; mean/median); default ~100k tokens; configurable per agent/tool.
- UI permissions: Granular per‑tool controls; per‑command prefix management; “Select All” and “Select All per tool”; trust flag for headless/E2E writes.


## Acceptance Criteria

1) Schema + UI
- [ ] Agent has a `working_directory` string field (nullable). UI exposes this in Agent form. The value sets the default cwd for all tools used by that agent.
- [ ] Agents.tools JSONB remains source of truth for tool enablement/permissions. UI continues to edit via `tools_json` virtual field.

- [ ] New context `TheMaestro.Tools` generated with Phoenix generator, plus a persisted audit model `ToolRun` capturing executions: agent_id (FK), session_id (FK), name, args (map), cwd, status, exit_code, started_at, finished_at, stdout/summary (text), stderr/summary (text), bytes_written, bytes_read, provider (map), call_request (map), call_response (map).
- [ ] Tool registry exposes Gemini‑parity set: file-system (list_directory, read_file, write_file, glob, search_file_content, replace), shell (run_shell_command), multi-file (read_many_files), web_fetch, google_web_search, and MCP tool interface (declaration only). Non‑Gemini web search integrates providers: Tavily (API), DuckDuckGo (Req-based), with optional Hound (browser automation) and Crawly (crawler) to build/search a local index.
- [ ] Generic `ToolRouter.execute/3` dispatches by normalized tool name and enforces safety/permissions derived from agent.tools settings + global denylist.

3) Safety & Permissions
- [ ] Implement global auto‑rejects (e.g., `rm -rf /`, `:(){ :|:& };:`, `dd of=/dev/`), deny command chaining by default (`&&`, `||`, `;`) unless explicitly allowed by config, and deny raw `sudo` (always blocked). Ensure prefix‑based blocklist takes precedence over allowlist.
- [ ] Default shell policy: allow all commands (subject to the global denylist and `sudo` block) unless restricted in the Agent UI. Provide granular controls, plus “Select All” and “Select All Per Tool” toggles.
- [ ] File ops restricted to agent working_directory root (or project root if unset). Paths are normalized and must resolve within the allowed root. Writes require explicit confirmation path in non‑headless UI; for headless/e2e, respect an explicit `trust` flag.

4) Provider Translators
- [ ] Provide translators to declare tools and transform tool calls/results per provider specs:
  - Anthropic: tools → `{name, input_schema}`; results injected as `tool_result` with matching `tool_use_id`.
  - OpenAI Responses: tools → `tools[]` including function tools; calls in stream → emit `function_call_output` back.
  - Gemini: tools → `functionDeclarations`; handle `functionCall`/`functionResponse` parity including inlineData for binary summaries.
- [ ] Name/parameter alignment exactly as in tool_call_matrix-codex.md and provider spec docs (e.g., read_file.absolute_path, write_file.file_path).

5) Streaming Loop Integration
- [ ] Update `TheMaestroWeb.SessionChatLive` turn pipeline to detect `:function_call` messages, synchronously execute tools via `ToolRouter`, push results back via provider‑specific continuation request (second round-trip where required), and continue streaming to final assistant text.
- [ ] Support parallel tool calls only where provider supports them; otherwise, serialize calls.

6) Web Tools Implementation
- [ ] `web_fetch`: use provider native URL tooling when available (Gemini), otherwise implement via Req fallback with clear source list embedded in output string. Confirm max-20 URLs and require http(s) scheme.
- [ ] `google_web_search`: Enable via multiple backends with provider-agnostic interface: Tavily (preferred), DuckDuckGo, optional Hound + Crawly for local indexing. Backend selection ordered by agent.tools settings; defaults Tavily → DuckDuckGo; Hound/Crawly disabled unless explicitly enabled. For Gemini, still expose as function tool with provider wiring.

7) Tests (REAL providers)
- [ ] Manual + automated E2E using real credentials for OpenAI, Anthropic, Gemini. Validate shell/file tools, and at least one round-trip tool call per provider (e.g., read_file) from chat UI.
- [ ] Unit tests for path sandboxing, command validation, and registry dispatch. Use local FS only; no mocks for provider loops.

8) Documentation
- [ ] Update docs with tool configuration examples in Agents, translator shapes per provider, and safety notes.


## Tooling Research (MANDATORY via Archon)
Before writing code for any phase, run targeted Archon queries (keep match_count 2–5):

- Broad design:
  - archon:perform_rag_query(query="Elixir safe shell execution patterns", match_count=3)
  - archon:perform_rag_query(query="Phoenix file IO security best practices", match_count=3)
- Low-level examples:
  - archon:search_code_examples(query="Elixir System.cmd examples", match_count=3)
  - archon:search_code_examples(query="Elixir Path.expand sandbox absolute path validation", match_count=3)
  - archon:search_code_examples(query="Elixir Req get binary body examples", match_count=3)
- Provider specifics:
  - archon:perform_rag_query(query="OpenAI Responses function_call_output examples", match_count=3)
  - archon:perform_rag_query(query="Anthropic Messages tool_use tool_result examples", match_count=3)
  - archon:perform_rag_query(query="Gemini functionDeclarations functionResponse examples", match_count=3)

Document findings inline in PRs and reference provider spec files in this repo.


## Data Model & Generators

1) Add working directory to Agents
- Migration: add `working_directory` (string) to `agents`.
- Schema: `field :working_directory, :string` in `TheMaestro.Agents.Agent`.
- LiveView Form: add `<.input field={@form[:working_directory]} type="text" label="Working Directory" />` below Model selector.
- Validation: if provided, must be an absolute path pointing to an existing directory during save (or warn when missing). Normalize with `Path.expand/1`.

2) Tools context and ToolRun schema (audit log)
- Generator:
  - mix phx.gen.context Tools ToolRun tool_runs \
      agent_id:references:agents \
      name:string status:string exit_code:integer \
      args:map cwd:string bytes_read:integer bytes_written:integer \
      stdout:text stderr:text started_at:utc_datetime finished_at:utc_datetime
- Migration tweaks:
  - Use UUID FK: `references(:agents, type: :binary_id, on_delete: :nilify_all)`.
  - Indices: `index(:tool_runs, [:agent_id])`, `index(:tool_runs, [:name, :inserted_at])`.
- Context functions:
  - `log_start/2`, `log_finish/2`, `log_error/2` returning updated ToolRun.
  - `latest_for_agent/2` with pagination.


## Tool Registry & Router

- Module: `TheMaestro.Tools.Registry`
  - Returns the catalog of available tools (Gemini parity) with internal spec: name, description, parameters schema, safety flags (needs_confirmation, writes_files, binary_output_summary, allow_parallel?).
  - Adapters for each tool to a normalized invocation spec `{module: M, fun: :run, validator: V}`.
- Module: `TheMaestro.Tools.Router`
  - `execute(agent, %FunctionCall{...}, opts)` returns `{ok, %ToolResult{...}} | {:error, reason}`.
  - Enforces safety: denylist>allowlist; command chain guard; base path confinement; file write confirmation via callback in UI path.
- Result shape: `%ToolResult{name, call_id, text, inline_data?, sources?}`. Text must be concise and deterministic per tool docs; for large/binary outputs, summarize.


## Implemented Tools (Parity with Gemini CLI)

1) Shell — `run_shell_command`
- Behavior: Execute a command in `agent.working_directory` via `System.cmd/3` with args split using a safe parser (no shell interpolation). For macOS/Linux, prefer exec via `{cmd, args}`; avoid `/bin/sh -c` unless explicitly whitelisted.
- Validation:
  - Disallow `&&`, `||`, `;`, `` `subshell` ``, `$()`, pipes with >1 segment unless allowed.
  - Denylist hard rules: `rm -rf /`, `rm -rf /*`, `mkfs`, `:(){ :|:& };:`, `shutdown`, `reboot`, `halt`, `dd .* of=/dev/`, `chmod -R 777 /`, `chown -R` on `/`, `sudo`.
  - Allowlist from agent.tools.core entries like "run_shell_command(git)", "run_shell_command(npm)"; prefix matching. If unspecified, disallow everything except an approved minimal set if owner agrees (clarify below).
- Output: return stdout (truncated to N kb, include a footer `[truncated]`), stderr summarized. Include `exit_code`.
- References: source/gemini-cli/docs/tools/shell.md

2) File System
- `list_directory` — list direct entries with dir first; options: ignore globs, respect_git_ignore (default true). Use File.ls!/1 and `git check-ignore` when repo. Output as formatted string per doc.
- `read_file` — text: return content with optional offset/limit and truncation preface. Binary images/PDF: return `inlineData` metadata (base64) but do not exceed memory limits (cap size and summarize). Other binaries: return message cannot display.
- `write_file` — requires confirmation; show diff summary (use :diffy or simple LCS) and write atomically (write temp + rename). Create parents if missing. Output success message per doc.
- `glob` — use `:filelib.wildcard` + custom modified-time sort; ignore `node_modules`, `.git` by default; respect_git_ignore (shell to `git check-ignore` list) if repo.
- `search_file_content` — prefer `git grep -n` when in repo; fallback to ripgrep or `:binary` scan; format results grouped by file.
- `replace` — single-occurrence literal replacement with strict context; if not found or multiple, fail. Provide multi-stage refine hook for future; for now, fail safely. Requires confirmation with diff.
- References: source/gemini-cli/docs/tools/file-system.md

3) Multi-file — `read_many_files`
- Behavior: accept list of glob patterns; concatenate text files with headers; for images/pdf/audio/video only when explicitly requested by extension/name; otherwise skip and summarize. Apply default excludes (.git, node_modules, build artifacts).
- References: source/gemini-cli/docs/tools/multi-file.md

4) Web — `web_fetch`, `google_web_search`
  - `web_fetch` — prefer Gemini urlContext path when provider is Gemini; otherwise, implement via Req fallback that fetches allowed URLs (http/https only), extracts HTML text with a minimal sanitizer, and returns a clear sources list + concise summary wrapper. Confirm if prompt includes >5 URLs (unless trusted). Hard caps per invocation.
  - `google_web_search` — Provider‑agnostic front‑end with pluggable backends: Tavily (preferred), DuckDuckGo, optional Hound (JS render/extract) and Crawly (crawl + index). Backend ordering is configured per agent; default: Tavily → DuckDuckGo → Hound → Crawly.
  - References: source/gemini-cli/docs/tools/web-fetch.md, source/gemini-cli/docs/tools/web-search.md

5) MCP — Interface only
- Expose MCP tool declarations from configured servers in agent.mcps but do not implement the protocol or transport yet. Names sanitized as `server__tool` and included in provider tool declarations. Actual execution will be implemented in the follow‑up "MCP protocol" story.
- References: source/gemini-cli/docs/tools/mcp-server.md


## Provider Translators

- Module: `TheMaestro.Providers.OpenAI.ToolsTranslator`
  - Build `tools[]` (Responses) function specs from Registry; include non-function entries when applicable in future.
  - Transform `%ToolResult{}` into `function_call_output` items with matching `call_id`.
  - Reference: docs/tool-specs/codex_tool_specs-codex.md; docs/tool-specs/tool_call_matrix-codex.md

- Module: `TheMaestro.Providers.Anthropic.ToolsTranslator`
  - Build `tools: [%{name, input_schema}]` exactly; transform `%ToolResult{}` into `tool_result` content with `tool_use_id` mapping.
  - Reference: docs/tool-specs/anthropic_tool_specs.md; docs/tool-specs/tool_call_matrix-codex.md

- Module: `TheMaestro.Providers.Gemini.ToolsTranslator`
  - Build `functionDeclarations` with `parametersJsonSchema`; transform `%ToolResult{}` into a user `functionResponse` part matching `functionCall.id`. Include `inlineData` sidecar for binary summaries.
  - Reference: docs/tool-specs/gemini_tool_specs-codex.md; docs/tool-specs/tool_call_matrix-codex.md

- Name/param normalization table — Follow the exact names used in Gemini CLI docs:
  - read_file.absolute_path; write_file.file_path; replace.old_string/new_string/expected_replacements; glob.pattern; search_file_content.pattern/include/path


## Streaming Loop Integration Plan

- Extend provider streaming modules to include tools in requests:
  - OpenAI (Responses): Add `tools` and `tool_choice` based on agent.tools; set `parallel_tool_calls` accordingly.
  - Gemini: Provide `functionDeclarations` in config; set `systemInstruction` with safety notes.
  - Anthropic: Provide `tools` array with input schemas; set `system` guidance.
- SessionChatLive loop changes:
  - When `TheMaestro.Streaming` yields `%{type: :function_call, function_call: [%FunctionCall{} | ...]}`, pause output accumulation and execute tool(s) via `ToolRouter` using agent context (auth/provider, working_directory, agent.tools permissions).
  - Post results back to provider using the provider translator + a continuation request (second API call), then resume streaming parse until `:done`.
  - Serialize or parallelize per provider capability. Maintain an ID map for call_id/tool_use_id/functionCall.id.
  - Persist each run to ToolRun and display a small log in UI (optional minimal indicator for this story).

## UI Changes
- Agents Form
  - Add Working Directory input (absolute path).
  - Add granular tool permission controls (per‑tool toggles, per‑command prefixes for shell).
  - Include “Select All” and “Select All per tool” convenience toggles.
  - Trust flag for headless/E2E write operations.
- Search Backend Config
  - Per‑agent ordering widget for Tavily/DuckDuckGo/Hound/Crawly, with advanced options (timeouts, concurrency caps, allowed domains, headless toggle, proxy, user agent).
- Dashboard (optional)
  - Recent ToolRuns list with filters and a detail view (stdout/stderr summaries, request/response metadata).

## Tokenization & Truncation
- Use a multi‑method estimator (character/word heuristics + approximate BPE + optional reference tokenizer per provider family).
- Drop outliers; compute mean and median; prefer conservative cap.
- Defaults: ~100k tokens per tool output; configurable per agent & tool.
- Always include explicit “[truncated]” markers and a guidance line for fetching more context safely.

## Testing (ALL WITH REAL PROVIDERS & REAL CREDS)
General
- Use real OAuth/API key sessions for each provider; no mocks for provider loops.
- Never bypass hooks; run `mix precommit` and fix issues locally.

Provider E2E
- OpenAI Responses: Force read_file tool; verify function_call_output + continuation.
- Anthropic: tool_use → tool_result path verified end‑to‑end.
- Gemini: functionCall → functionResponse; verify final completion.

System Tests
- Shell: allow‑all default works; sudo blocked; denylist blocks destructive commands; prefix excludes (e.g., git push) honored.
- FS: read_file truncation; write_file diff confirmation; replace single occurrence; glob + search respect gitignore.
- Web: web_fetch returns sources; >5 URLs confirmation; per‑agent backend ordering.
- Search: Tavily and DuckDuckGo return summaries with sources; Hound renders JS page; Crawly runs small, polite crawl (robots, Hammer, jittered backoff).

Unit Tests (non‑provider)
- Path confinement and symlink escape prevention.
- Shell validator (chaining, sudo, denylist precedence).
- Token estimator ensemble behavior.
- Router permission resolution and ToolRun logging.

Reliability
- No artificial 10s timeouts; long‑running processes are killed manually after testing.
- Crawling politeness: robots compliance, Hammer rate limits, backoff with jitter, concurrency caps.

## Step‑by‑Step Checklists
Phase 0 — Research (Archon + Local)
- [ ] Run Archon queries and capture notes in PRs.
- [ ] Review Gemini CLI tools docs and provider specs.

Phase 1 — Schema & UI
- [x] Add agents.working_directory; schema + form.
- [ ] Add granular permission UI and trust flag.

Phase 2 — Context & Audit
- [x] Generate Tools.ToolRun; implement log_start/log_finish/log_error; latest_for_agent.

Phase 3 — Registry & Router
- [ ] Registry metadata; Router.execute rules with safety and token truncation.

Phase 4 — Search Backends
- [ ] Tavily and DuckDuckGo; optional Hound and Crawly.

Phase 5 — Translators
- [ ] Gemini/OpenAI/Anthropic translators; unit tests of shapes.

Phase 6 — Streaming Loop
- [ ] Execute → inject result → continue for all providers.

Phase 7 — Docs & Clean‑up
- [ ] Examples, screenshots, and telemetry notes; run precommit.


## Agent.tools Configuration (JSON examples)

Minimal allow shell only for git and npm, deny push:
```json
{
  "core": ["run_shell_command(git)", "run_shell_command(npm)", "read_file", "list_directory"],
  "exclude": ["run_shell_command(git push)", "run_shell_command(rm)"]
}
```

Full file system with writes guarded and search enabled:
```json
{
  "core": [
    "read_file", "write_file", "glob", "list_directory", "search_file_content", "replace", "read_many_files"
  ],
  "exclude": [],
  "trust": false
}
```

Gemini web tools only:
```json
{
  "core": ["web_fetch", "google_web_search"],
  "exclude": []
}
```


## UI Changes

- Agents Form (lib/the_maestro_web/live/agent_live/form.ex)
  - Add Working Directory input.
  - Keep Tools/MCPs/Memory textareas.
  - Add granular tool permission controls (checkbox lists for per-command prefixes and per-tool toggles), including “Select All” and “Select All Per Tool”.
- Agents Index/Show
  - Optionally display working directory.
- Session Chat
  - For this story: no major UI changes required beyond ensuring function_call handling is integrated. Optional: print tool call banners in streaming area for operator visibility.


## Testing (ALL WITH REAL PROVIDERS & REAL CREDS)

General
- Use the existing end‑to‑end scripts under scripts/ or add new ones as listed below. Environment must have real OAuth/API key sessions for each provider.
- NEVER bypass hooks. Run `mix precommit` locally and fix lint/format/test before commit.

Provider E2E scripts (add if missing)
- scripts/test_full_openai_tools_e2e.exs — Sends a prompt that forces `read_file` then expects an assistant text that mentions file content. Validate tool_call → function_call_output flow.
- scripts/test_full_anthropic_tools_e2e.exs — Same for Anthropic with `tool_use`/`tool_result`.
- scripts/test_full_gemini_tools_e2e.exs — Same for Gemini with `functionCall`/`functionResponse`.

Manual System Tests
- Shell safety:
  - Agent.tools excludes `run_shell_command`; try `ls` → blocked.
  - Allow `run_shell_command(git)`; run `git status` in working dir → success; run `git push` → blocked by exclude.
  - Attempt `rm -rf /` by prompt → auto‑reject with clear error message; ensure no execution attempted.
- File system:
  - read_file on a text file; verify truncation handling with offset/limit.
  - write_file: confirm UI confirmation diff appears (or trust flag flow in headless), verify atomic write.
  - replace: provide precise context; verify exactly one replacement.
  - glob/search_file_content: verify gitignore respect and output formatting.
- Web:
  - web_fetch with 2–3 URLs; for Gemini verify provider URL context path; for fallback providers verify Req fetch and sources list.

Unit Tests (non‑provider)
- Path normalization and confinement to working_directory; attempts to escape via `..` or symlinks must fail.
- Command parser and validation (denylist, chaining, sudo) — pure functions with table‑driven tests.
- ToolRouter dispatch; ToolRun audit logging.

Performance/Resiliency
- Ensure no 10s timeouts; streaming and tool execution use generous timeouts or explicit ones per action. Shell commands get a configurable timeout; default large (e.g., 5m) for dev; kill when done.
- Truncation is token-aware and configurable per agent; default to ~100k tokens. Use active model tokenizer to compute cutoffs.


## Dev Notes & Best Practices

- Elixir/Phoenix rules (project guidelines):
  - Use Req for HTTP. Avoid installing extra clients. Prefer `Req.request!/1` or streaming adapter already present.
  - Do not use `String.to_atom/1` on user content. Validate and keep binaries.
  - Keep modules single‑purpose; avoid nesting multiple modules per file.
  - Use `Task.async_stream/3` for multi‑file reads when needed; set `timeout: :infinity` if warranted.
  - HEEx rules: use `<.form>` and `<.input>`; do not access changesets in templates directly; use `to_form/2` assigns.

- Safety:
  - Denylist precedes allowlist; explicit excludes win.
  - Confirm writes with a diff; never write blind.
  - Constrain FS ops to working_directory root.
  - Summarize large/binary outputs; never stream megabytes into the model.

- Provider specifics (see docs/tool-specs/*): match parameter names and message shapes exactly. Subtle differences:
  - Anthropic uses `tool_use` + `tool_result` content blocks; IDs must match.
  - OpenAI Responses uses `function_call` + `function_call_output` input items; not Chat tools here.
  - Gemini uses `functionDeclarations` and user‑side `functionResponse` parts; include `inlineData` for binary payloads when needed.

- Avoid code duplication:
  - One registry and one router; separate provider translators only for wire shapes.
  - Shared validators for shell and FS across providers.
  - Reuse existing HTTP streaming adapter and provider client factories.

- Git policy:
  - Never bypass hooks. If hooks fail, fix (format, test, credo, security) then commit normally.


## Step‑by‑Step Checklists

Phase 0 — Research (Archon + Local Docs)
- [ ] Run all Archon queries listed above and capture notes.
- [ ] Read all Gemini CLI tool docs under source/gemini-cli/docs/tools/*.
- [ ] Read tool_call_matrix and provider spec docs under docs/tool-specs/*.

Phase 1 — Schema & UI
- [ ] Add migration: agents.working_directory (string).
- [ ] Update schema `TheMaestro.Agents.Agent` with field and changeset validation.
- [ ] Update Agents form LiveView with Working Directory input.
- [ ] Verify list/show pages render working directory safely.

Phase 2 — Context & Audit
- [ ] Generate `Tools.ToolRun` and adjust migration for UUID FK.
- [ ] Implement `TheMaestro.Tools` context helpers (log_start/log_finish/log_error, latest_for_agent).

Phase 3 — Registry & Router
- [x] Implement `TheMaestro.Tools.Registry` with tool metadata and parameter schemas.
- [x] Implement `TheMaestro.Tools.Router.execute/3` stub and wire non-destructive tool modules (pending full safety/confirmations).
- [x] Implement non-destructive FS tool module (list_directory, read_file, glob, search_file_content).
- [ ] Implement shell, write_file, replace with safety and confirmations.

Phase 4 — Translators
- [ ] Implement provider translators for Anthropic/OpenAI/Gemini.
- [ ] Unit‑test that declarations match the shapes in docs/tool-specs/* exactly.

Phase 5 — Streaming Loop
- [ ] Extend provider requests to include tools per agent.tools.
- [ ] Update SessionChatLive to handle :function_call → execute → continue pattern.
- [ ] Verify ID mapping correctness and sequencing by provider.

Phase 6 — Tests (Real Providers)
- [ ] Add/verify E2E scripts for each provider.
- [ ] Run manual tests for safety cases and FS/web flows.
- [ ] Run `mix precommit` and fix all issues.

Phase 7 — Docs
- [ ] Add examples of agent.tools JSON configurations.
- [ ] Add translator reference snippets (with links to repo docs).


## Decisions (Owner‑Approved)
1) Shell defaults: Allow all by default; never allow sudo; enforce global denylist. Provide granular UI restrictions with select‑all toggles.
2) ToolRun persistence: Persist to DB with agent_id, session_id, timestamps, provider metadata, and full call API request/response payloads.
3) Non‑Gemini web search: Add backends now — Tavily and DuckDuckGo; optional Hound and Crawly for scraping/crawling to feed a local index.
4) Confirmation UX: UI must expose granular controls; include “select all” and “select all per tool”. Trust flag allowed for headless/E2E.
5) Truncation caps: Token‑based; default 100k tokens; configurable per agent.


## References (must review during development)
- Gemini CLI tools: source/gemini-cli/docs/tools/*.md
- Provider matrices/specs: docs/tool-specs/*.md
- Project standards: AGENTS.md, CLAUDE.md, docs/architecture/*.md, docs/stories/0.6.story.md (end‑to‑end scripts), docs/prd/*.md


## Definition of Done
- Agents have working_directory with UI; tools registry/router implemented with Gemini parity; provider translators shape‑correct per spec; function_call loop integrated enough to handle read_file end‑to‑end on all three providers; safety policies enforced; tests run with real creds for all three providers.
